var _MAX_POINT_INTERVAL_MS=15e3,_SECOND_IN_MILLIS=1e3,_MINUTE_IN_MILLIS=60*_SECOND_IN_MILLIS,_HOUR_IN_MILLIS=60*_MINUTE_IN_MILLIS,_DEFAULT_MARKER_OPTS={startIconUrl:"pin-icon-start.png",endIconUrl:"pin-icon-end.png",shadowUrl:"pin-shadow.png",iconSize:[33,50],shadowSize:[50,50],iconAnchor:[16,45],shadowAnchor:[16,47]},_DEFAULT_POLYLINE_OPTS={color:"blue"};L.GPX=L.FeatureGroup.extend({initialize:function(t,n){n.max_point_interval=n.max_point_interval||_MAX_POINT_INTERVAL_MS,n.marker_options=this._merge_objs(_DEFAULT_MARKER_OPTS,n.marker_options||{}),n.polyline_options=this._merge_objs(_DEFAULT_POLYLINE_OPTS,n.polyline_options||{}),L.Util.setOptions(this,n),L.GPXTrackIcon=L.Icon.extend({options:n.marker_options}),this._gpx=t,this._layers={},this._info={name:null,length:0,elevation:{gain:0,loss:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0}},t&&this._parse(t,n,this.options.async)},get_duration_string:function(t,n){var e="";t>=_HOUR_IN_MILLIS&&(e+=Math.floor(t/_HOUR_IN_MILLIS)+":",t%=_HOUR_IN_MILLIS);var i=Math.floor(t/_MINUTE_IN_MILLIS);t%=_MINUTE_IN_MILLIS,10>i&&(e+="0"),e+=i+"'";var o=Math.floor(t/_SECOND_IN_MILLIS);return t%=_SECOND_IN_MILLIS,10>o&&(e+="0"),e+=o,e+=!n&&t>0?"."+Math.round(1e3*Math.floor(t))/1e3:'"'},to_miles:function(t){return t/1.60934},to_ft:function(t){return 3.28084*t},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_desc:function(){return this._info.desc},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/36e5)},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/36e5)},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(n){return t._prepare_data_point(n,t.m_to_km,null,function(t,n){return t.toFixed(2)+" km, "+n.toFixed(0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(n){return t._prepare_data_point(n,t.m_to_mi,t.to_ft,function(t,n){return t.toFixed(2)+" mi, "+n.toFixed(0)+" ft"})})},get_average_hr:function(){return this._info.hr.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(n){return t._prepare_data_point(n,t.m_to_km,null,function(t,n){return t.toFixed(2)+" km, "+n.toFixed(0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(n){return t._prepare_data_point(n,t.m_to_mi,null,function(t,n){return t.toFixed(2)+" mi, "+n.toFixed(0)+" bpm"})})},reload:function(){this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,n){var e={};for(var i in t)e[i]=t[i];for(var i in n)e[i]=n[i];return e},_prepare_data_point:function(t,n,e,i){var o=[n&&n(t[0])||t[0],e&&e(t[1])||t[1]];return o.push(i&&i(o[0],o[1])||o[0]+": "+o[1]),o},_load_xml:function(t,n,e,i){void 0==i&&(i=this.options.async),void 0==e&&(e=this.options);var o=new window.XMLHttpRequest;o.open("GET",t,i);try{o.overrideMimeType("text/xml")}catch(r){}o.onreadystatechange=function(){if(4==o.readyState&&200==o.status)if(o.responseXML)n(o.responseXML,e);else{var t=new DOMParser,i=t.parseFromString(o.response,"text/xml");n(i,e)}},o.send(null)},_parse:function(t,n,e){var i=this,o=function(t,n){var e=i._parse_gpx_data(t,n);e&&(i.addLayer(e),i.fire("loaded"))};if("<"===t.substr(0,1)){var r=new DOMParser;setTimeout(function(){o(r.parseFromString(t,"text/xml"),n)})}else this._load_xml(t,o,n,e)},_parse_gpx_data:function(t,n){var e,i,o,r=[],a=[["rte","rtept"],["trkseg","trkpt"]],_=t.getElementsByTagName("name");_.length>0&&(this._info.name=_[0].textContent);var s=t.getElementsByTagName("desc");s.length>0&&(this._info.desc=s[0].textContent);var h=t.getElementsByTagName("author");h.length>0&&(this._info.author=h[0].textContent);var l=t.getElementsByTagName("copyright");for(l.length>0&&(this._info.copyright=l[0].textContent),e=0;e<a.length;e++)for(o=t.getElementsByTagName(a[e][0]),i=0;i<o.length;i++){var u=this._parse_trkseg(o[i],t,n,a[e][1]);if(0!==u.length){var m=new L.Polyline(u,n.polyline_options);if(this.fire("addline",{line:m}),r.push(m),n.marker_options.startIconUrl){var g=new L.Marker(u[0],{clickable:!1,icon:new L.GPXTrackIcon({iconUrl:n.marker_options.startIconUrl})});this.fire("addpoint",{point:g}),r.push(g)}n.marker_options.endIconUrl&&(g=new L.Marker(u[u.length-1],{clickable:!1,icon:new L.GPXTrackIcon({iconUrl:n.marker_options.endIconUrl})}),this.fire("addpoint",{point:g}),r.push(g))}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),r.length){var p=r[0];return r.length>1&&(p=new L.FeatureGroup(r)),p}},_parse_trkseg:function(t,n,e,i){var o=t.getElementsByTagName(i);if(!o.length)return[];for(var r=[],a=null,_=0;_<o.length;_++){var s,h=new L.LatLng(o[_].getAttribute("lat"),o[_].getAttribute("lon"));if(h.meta={time:null,ele:null,hr:null},s=o[_].getElementsByTagName("time"),s.length>0&&(h.meta.time=new Date(Date.parse(s[0].textContent))),s=o[_].getElementsByTagName("ele"),s.length>0&&(h.meta.ele=parseFloat(s[0].textContent)),s=o[_].getElementsByTagNameNS("*","hr"),s.length>0&&(h.meta.hr=parseInt(s[0].textContent),this._info.hr._points.push([this._info.length,h.meta.hr]),this._info.hr._total+=h.meta.hr),this._info.elevation._points.push([this._info.length,h.meta.ele]),this._info.duration.end=h.meta.time,null!=a){this._info.length+=this._dist3d(a,h);var l=h.meta.ele-a.meta.ele;l>0?this._info.elevation.gain+=l:this._info.elevation.loss+=Math.abs(l),l=Math.abs(h.meta.time-a.meta.time),this._info.duration.total+=l,l<e.max_point_interval&&(this._info.duration.moving+=l)}else this._info.duration.start=h.meta.time;a=h,r.push(h)}return r},_dist2d:function(t,n){var e=6371e3,i=this._deg2rad(n.lat-t.lat),o=this._deg2rad(n.lng-t.lng),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(n.lat))*Math.sin(o/2)*Math.sin(o/2),a=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),_=e*a;return _},_dist3d:function(t,n){var e=this._dist2d(t,n),i=Math.abs(n.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(e,2)+Math.pow(i,2))},_deg2rad:function(t){return t*Math.PI/180}});
